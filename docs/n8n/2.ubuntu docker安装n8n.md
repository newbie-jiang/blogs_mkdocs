# 快速安装（Docker Compose，含 Postgres 持久化）

### 1) 安装 Docker & Compose 插件

```
# 安装 Docker 官方源并安装
sudo apt update

sudo apt install -y ca-certificates curl gnupg

sudo install -m 0755 -d /etc/apt/keyrings

curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
 | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
 
echo \
"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
 https://download.docker.com/linux/ubuntu $(. /etc/os-release; echo $VERSION_CODENAME) stable" \
 | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
 
sudo apt update

sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 把当前用户加入 docker 组（重新登录后生效）
sudo usermod -aG docker $USER
```

（n8n 官方“Docker/Compose 部署”文档推荐用 Docker 运行。[n8n文档+1](https://docs.n8n.io/hosting/installation/server-setups/docker-compose/?utm_source=chatgpt.com)）

### 2) 准备目录与配置

```
mkdir -p ~/n8n/{data,.env.d}
cd ~/n8n
```

生成一个**加密密钥**（用于加密凭据）并先保存：

```
openssl rand -hex 32 | tee .env.d/N8N_ENCRYPTION_KEY
```

（n8n 首次启动会生成随机密钥，也可用环境变量显式指定；队列/多进程时必须显式指定同一个密钥。[n8n文档](https://docs.n8n.io/hosting/configuration/configuration-examples/encryption-key/?utm_source=chatgpt.com)）

创建 **.env**（按需改域名/密码）：

- n8n.example.com
- Another_Strong_Pass

```
cat > .env <<'EOF'

POSTGRES_USER=n8n
POSTGRES_PASSWORD=change_me_strong
POSTGRES_DB=n8n
N8N_HOST=n8n.example.com
N8N_PROTOCOL=https
WEBHOOK_URL=https://n8n.example.com/
TZ=Asia/Tokyo
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=Another_Strong_Pass
N8N_ENCRYPTION_KEY_FILE=/files/N8N_ENCRYPTION_KEY
N8N_SECURE_COOKIE=false
EOF
```

> 说明：n8n 的 Webhook 在反代后需要显式设置 `WEBHOOK_URL` 才能正确回显/注册外部 Webhook。[n8n文档](https://docs.n8n.io/hosting/configuration/configuration-examples/webhook-url/?utm_source=chatgpt.com)
>  可用的环境变量详见官方总表（部署/端点/安全/数据库等）。[n8n文档+2n8n文档+2](https://docs.n8n.io/hosting/configuration/environment-variables/deployment/?utm_source=chatgpt.com)

### 3) 写 `docker-compose.yml`

```
services:
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  n8n:
    image: n8nio/n8n:1.107.4
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - N8N_HOST=${N8N_HOST}
      - N8N_PROTOCOL=${N8N_PROTOCOL}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - TZ=${TZ}
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - N8N_ENCRYPTION_KEY_FILE=/files/N8N_ENCRYPTION_KEY
      - N8N_SECURE_COOKIE=false
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - n8n_data:/home/node/.n8n
      - ./.env.d:/files:ro

volumes:
  n8n_data:

```

> n8n 默认数据库是 **SQLite**，生产环境建议用 **PostgreSQL**；MySQL/MariaDB 自 v1.0 起已弃用。上面已按官方变量配置 Postgres。[n8n文档+1](https://docs.n8n.io/hosting/configuration/supported-databases-settings/?utm_source=chatgpt.com)

### 4) 启动

```
docker compose pull
docker compose up -d
```

访问：

- 临时直连测试：`http://<服务器IP>:5678`
- 有域名+反代：`https://n8n.example.com`（见下）

首次进入会创建管理员账户。若开启了基础认证，会先弹出浏览器的 BasicAuth。端口与 URL 设置请与 `WEBHOOK_URL` 保持一致，特别是在反向代理后。[n8n文档](https://docs.n8n.io/hosting/configuration/configuration-examples/webhook-url/?utm_source=chatgpt.com)



## 升级到“最新”

使用了 `n8nio/n8n:latest`，升级只需：

```
cd ~/n8n
docker compose pull n8n
docker compose up -d n8n
docker compose exec n8n n8n --version
```



## 容器与进程状态

```
cd ~/n8n

# 看容器是否都在运行
docker compose ps

# 近 100 行 n8n 日志，是否有 “ready / listening / migrations finished” 等字样
docker compose logs --tail=100 n8n
```

正常：`State` 为 `running`，日志里没有反复报错或重启。



## 出现问题

现在还没有配置域名，直接ip访问  ip:5678

![image-20250825230350591](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/TyporaJPG/image-20250825230350591.png)

N8N_SECURE_COOKIE 需要设置为为`false`  才可以http访问 

在刚才的.env 文件中最后添加一句

```
N8N_SECURE_COOKIE=false
```

以及docker-compose.yml

```
    environment:
      - DB_TYPE=postgresdb
      ...
      - N8N_ENCRYPTION_KEY_FILE=/files/N8N_ENCRYPTION_KEY
      - N8N_SECURE_COOKIE=false     # ← 新增
```

重启服务并验证：

```
cd ~/n8n
docker compose down
docker compose up -d
docker compose logs --tail=80 n8n
curl -sS -o /dev/null -w 'HTTP %{http_code}\n' http://127.0.0.1:5678/
```

浏览器端建议**清一下站点 Cookie**或用隐私窗口重新登录。



- 登录注册一下就进来了

![image-20250825231959205](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/TyporaJPG/image-20250825231959205.png)