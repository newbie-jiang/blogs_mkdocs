# linux下使用cubeprogrammer下载问题

-  STM32CubeProgrammer/STM32 ST-LINK 在 Linux 下常见的“无权限访问 USB 设备节点”问题

```
hdj@hdj-virtual-machine:~/zephyrproject/zephyr$ sudo west flash
[sudo] password for hdj: 
sudo: west: command not found
hdj@hdj-virtual-machine:~/zephyrproject/zephyr$ west flash
-- west flash: rebuilding
ninja: no work to do.
-- west flash: using runner stm32cubeprogrammer
      -------------------------------------------------------------------
                        STM32CubeProgrammer v2.20.0                  
      -------------------------------------------------------------------

libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
ST-LINK error (DEV_CONNECT_ERR)
FATAL ERROR: command exited with status 1: /usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/bin/STM32_Programmer_CLI --connect 'port=swd reset=HWrst' --download /home/hdj/zephyrproject/zephyr/build/zephyr/zephyr.hex --start
hdj@hdj-virtual-machine:~/zephyrproject/zephyr$ 

```



## udev 规则文件来源

STM32CubeProgrammer 的 udev 规则文件通常在**安装路径下的 `Drivers/rules/` 目录**，

```
/usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/Drivers/rules/
```



```shell
hdj@hdj-virtual-machine:/usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/Drivers/rules$ pwd
/usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/Drivers/rules
hdj@hdj-virtual-machine:/usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/Drivers/rules$ ls -al
total 56
drwxr-xr-x 2 root root  4096  8月  1 20:06 .
drwxr-xr-x 4 root root  4096  8月  1 20:06 ..
-rw-r--r-- 1 root root   604  7月 19  2024 49-stlinkv2-1.rules
-rw-r--r-- 1 root root   480  7月 19  2024 49-stlinkv2.rules
-rw-r--r-- 1 root root   982  7月 19  2024 49-stlinkv3.rules
-rw-r--r-- 1 root root    97  7月 19  2024 50-usb-conf.rules
-rw-r--r-- 1 root root 21179  7月 19  2024 99-jlink.rules
-rw-r--r-- 1 root root   220  7月 19  2024 Readme.txt
-rw-r--r-- 1 root root     5  7月 19  2024 version.txt

```



将这些 `.rules` 文件**拷贝到系统的 udev 目录**（通常 `/etc/udev/rules.d/` 或 `/lib/udev/rules.d/`，推荐后者）

这里我全部拷贝了

```
sudo cp /usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/Drivers/rules/*.rules /etc/udev/rules.d/
sudo cp /usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/Drivers/rules/*.rules /lib/udev/rules.d/
```



## 重新加载 udev 规则

```
sudo udevadm control --reload-rules
sudo udevadm trigger
```

## 拔插你的 ST-LINK 或开发板的 USB，再尝试下载

```
west flash
```



**zephyr 下载成功日志**

```
hdj@hdj-virtual-machine:~/zephyrproject/zephyr$ west flash
-- west flash: rebuilding
ninja: no work to do.
-- west flash: using runner stm32cubeprogrammer
      -------------------------------------------------------------------
                        STM32CubeProgrammer v2.20.0                  
      -------------------------------------------------------------------

ST-LINK SN  : 0024001B3033510135393935
ST-LINK FW  : V3J16M7
Board       : STM32H7S78-DK
Voltage     : 3.28V
SWD freq    : 8000 KHz
Connect mode: Under Reset
Reset mode  : Hardware reset
Device ID   : 0x485
Revision ID : Rev Y
Device name : STM32H7RSxx
Flash size  : 64 KBytes (default)
Device type : MCU
Device CPU  : Cortex-M7
BL Version  : 0xE3



Opening and parsing file: zephyr.hex


Memory Programming ...
  File          : zephyr.hex
  Size          : 19.13 KB 
  Address       : 0x08000000


Erasing memory corresponding to segment 0:
Erasing internal memory sectors [0 2]
Download in Progress:
[==================================================] 100% 

File download complete
Time elapsed during download operation: 00:00:00.529

RUNNING Program ... 
  Address:      : 0x8000000
Application is running, Please Hold on...
Start operation achieved successfully

```



参考

https://community.st.com/t5/stm32cubeprogrammer-mcus/error-connecting-with-st-link-in-linux/m-p/691460#M6688