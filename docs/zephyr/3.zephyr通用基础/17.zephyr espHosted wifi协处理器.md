## zephyr 官方介绍

https://docs.zephyrproject.org/latest/build/dts/api/bindings/wifi/espressif%2Cesp-hosted.html?utm_source=chatgpt.com

## 乐鑫官方介绍

https://github.com/espressif/esp-hosted?utm_source=chatgpt.com

https://github.com/espressif/esp-hosted-mcu

## spi协议说明

https://github.com/espressif/esp-hosted/blob/master/esp_hosted_ng/docs/spi_protocol.md?utm_source=chatgpt.com

## **EDC22：ESP-Hosted — 用 ESP32 做 Wi-Fi/BT 协处理器**（演讲，概念/架构/连接方式，虽非专讲 Zephyr，但对整体理解很关键）

https://www.youtube.com/watch?v=g14aEjnjRLw

## 聆思科技的社区记录（最终使用的是esp32 c3 协处理器方案，esp32c2有bug）

https://github.com/espressif/esp-hosted/issues/519?utm_source=chatgpt.com

## 维护者回复里明确提到“已经把 MCU 方案移植到 **Zephyr RTOS**”，可作为曾被使用/移植的参考

https://github.com/espressif/esp-hosted/issues/133?utm_source=chatgpt.com

# ESP-Hosted-MCU：Espressif SoC 作为通信协处理器

[![组件注册表](https://camo.githubusercontent.com/1254b0dbe0cc9181ee431539a5ff6d34c5462ece1ed26b25aa1cec5dc0d402a4/68747470733a2f2f636f6d706f6e656e74732e6573707265737369662e636f6d2f636f6d706f6e656e74732f6573707265737369662f6573705f686f737465642f62616467652e737667)](https://components.espressif.com/components/espressif/esp_hosted)

## 1 简介



ESP-Hosted-MCU 是一款开源解决方案，允许您使用乐鑫芯片组和模组作为通信协处理器。该解决方案为主机微处理器或微控制器提供无线连接（Wi-Fi 和蓝牙），使其能够与其他设备通信。此外，用户可以完全控制协处理器的资源。

该高级框图显示了 ESP-Hosted 与主机 MCU 和从属协处理器的关系。

[![ESP托管](https://github.com/espressif/esp-hosted-mcu/raw/main/docs/images/ESP-Hosted-FG-MCU_design.svg)](https://github.com/espressif/esp-hosted-mcu/blob/main/docs/images/ESP-Hosted-FG-MCU_design.svg)

Wi-Fi和蓝牙的详细设计图可以参考以下设计文档：

- [WiFi设计](https://github.com/espressif/esp-hosted-mcu/blob/main/docs/wifi_design.md)
- [蓝牙设计](https://github.com/espressif/esp-hosted-mcu/blob/main/docs/bluetooth_design.md)

`esp-hosted-mcu`专用于任何主机作为 MCU 的支持。如果您对 Linux 主机感兴趣，请参阅[`esp-hosted`](https://github.com/espressif/esp-hosted)代码库。

## 2 架构



##### 托管协处理器



这是一个提供Wi-Fi、蓝牙和其他功能的ESP芯片。它也可以`hosted-slave`互换使用。

##### 主机 MCU



这可以是任何通用微控制器 (MCU)。我们演示了任何 ESP 作为主机的情况。使用端口层，任何主机都可以充当主机 MCU。

##### 沟通



- 主机通过远程过程调用 (RPC) 扩展托管协处理器的功能。主机 MCU 使用可靠的通信总线（例如 SPI、SDIO 或 UART）将这些 RPC 命令发送到托管协处理器。托管协处理器随后处理 RPC 并向主机 MCU 提供所请求的功能。
- 数据（网络或蓝牙）在传输层被有效地打包，以最大限度地减少在主机和协处理器之间传递时的开销和延迟。
- 这种模块化设计允许任何 MCU 用作主机，任何带有 Wi-Fi 和/或蓝牙的 ESP 芯片均可用作主机协处理器。RPC 调用也可以扩展，以提供主机所需的任何功能，只要协处理器能够支持即可。

## 3 解决方案灵活性



- 任何 MCU 都可以作为主机
  - 您可以将 ESP 作为示例主机进行评估，然后将 ESP-Hosted 移植到您想要的 MCU。
- 任何 ESP 芯片都可以作为协处理器
  - 任何支持 Wi-Fi 和/或蓝牙的 ESP 芯片组都可以选择作为协处理器
  - 根据您的产品需求选择协处理器设备。ESP[产品选择器](https://www.espressif.com/en/products/socs)可以帮助您。
- 灵活的传输层（SDIO、SPI、UART）
  - ESP-Hosted 支持主机和协处理器之间的各种通信接口，让您可以根据自己的应用选择最合适的接口。
  - 任何其他新的传输方式也可以添加到开源代码中
- 完全控制协处理器的资源
  - 用户不仅限于使用协处理器进行无线连接。他们可以完全控制协处理器的资源，从而实现更灵活、更强大的系统。
- 可扩展的 RPC 库
  - ESP-Hosted 使用的远程过程调用 (RPC) 可以扩展，以提供主机所需的任何功能，只要协处理器能够支持即可。目前，[ESP-IDF](https://github.com/espressif/esp-idf) Wi-Fi 的基本功能已实现。

## 4 使用 ESP32-P4-Function-EV-Board 的快速演示



迫不及待地想测试？我们帮您搞定！[ESP32-P4-Function-EV-Board](https://www.espressif.com/en/products/socs/esp32-p4)可用作主机 MCU，并搭载板载[ESP32-C6](https://www.espressif.com/en/products/socs/esp32-c6)作为协处理器，两者已通过 SDIO 连接并作为传输接口。前提条件：您需要一块 ESP32-P4-Function-EV-Board。

笔记

如果您已经设置了 ESP-IDF（版本 5.3 或更高版本），则可以跳至[5 源代码和依赖项](https://github.com/espressif/esp-hosted-mcu#5-source-code-and-dependencies)。

### 4.1 设置 ESP-IDF



- 视窗
  - [按照Windows 工具链标准设置](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/windows-setup.html)中的说明，在 Windows 上安装并设置 ESP-IDF 。
  - 使用 ESP-IDF [Powershell 命令提示符](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/windows-setup.html#using-the-command-prompt)移动到预期
- Linux 或 MacOS
  - 狂欢

```
bash docs/setup_esp_idf__latest_stable__linux_macos.sh
```



- 鱼

```
fish docs/setup_esp_idf__latest_stable__linux_macos.fish
```



### 4.2 使用 C6 设置 P4



主机 ESP32-P4 缺乏原生 Wi-Fi/蓝牙支持。我们的[快速演示](https://github.com/espressif/esp-hosted-mcu/blob/main/docs/esp32_p4_function_ev_board.md)将帮助您在 P4-SDIO-C6 上运行 iperf。

### 4.3 没有 ESP32-P4-Function-EV-Board？



如果您没有 ESP32-P4，也不用担心。事实上，大多数用户都没有。您可以选择并使用任意两个 ESP 芯片组/SoC/模块/开发套件。开发套件使用起来很方便，因为它们已经配备了 GPIO 接口。这两个 ESP 芯片组中，一个可以充当主机，另一个可以充当从机/协处理器。但是，由于它们并非直接连接，您需要手动连接一些传输设备，这将在本节后面进行解释[`Detailed Setup`](https://github.com/espressif/esp-hosted-mcu#7-detailed-setup)。

## 5 源代码和依赖项



### 5.1 ESP-Hosted-MCU 源代码



- [`esp_hosted`ESP-Hosted-MCU 代码可在 Espressif Registry Component (ESP-Hosted)](https://components.espressif.com/components/espressif/esp_hosted)或 GitHub repo中找到[`esp-hosted-mcu`](https://github.com/espressif/esp-hosted-mcu/)
- 如果您有 ESP 作为主机，则**不需要**ESP-Hosted repo 克隆。
  - 原因：[ESP 组件管理器](https://docs.espressif.com/projects/esp-idf/en/stable/esp32/api-guides/tools/idf-component-manager.html)在构建时自动克隆 esp 托管的组件。
- 但是，对于非 ESP 主机开发，您可以使用命令克隆 repo：

```
git clone --recurse-submodules --depth 1 https://github.com/espressif/esp-hosted-mcu.git
```



### 5.2 依赖项



ESP-Hosted-MCU 解决方案依赖于`ESP-IDF`，`esp_wifi_remote`并且`protobuf-c`

###### ESP-IDF



- [`ESP-IDF`](https://github.com/espressif/esp-idf)是支持 Windows、Linux 和 macOS 的 Espressif SoC 的开发框架
- ESP-Hosted-MCU 解决方案以 ESP-IDF 为基础软件。ESP 芯片组作为主机和从机，始终致力于设计能够复用 ESP-IDF 组件的方式。
- 虽然我们完全理解，如果使用非 ESP 芯片组，主机 MCU 可能不希望依赖 ESP-IDF。端口层的编写旨在避免此类依赖。一些关键的 ESP-IDF 组件也可以直接复制粘贴，以加快非 ESP 主机的开发速度。

###### Wi-Fi 遥控器



- [`esp_wifi_remote`](https://components.espressif.com/components/espressif/esp_wifi_remote)例如，“Wi-Fi Remote” 是一个非常精简的接口，由 ESP-IDF 提供的 Wi-Fi API 组成，这些 API 的定义非常空洞。这些 API 的实际定义由 ESP-Hosted-MCU 提供。
- [Wi-Fi 远程代码可以在GitHub Repo](https://github.com/espressif/esp-wifi-remote/)或[Espressif Registry Component](https://components.espressif.com/components/espressif/esp_wifi_remote)中找到

###### Protobuf



- [`protobuf-c`](https://github.com/protobuf-c/protobuf-c)是Google提供的数据序列化框架，主机和从机之间通信的RPC消息采用protobuf编码。
- 它有助于避免手动序列化或字节顺序转换。
- 为用户提供灵活性，将 ESP-Hosted-MCU RPC 框架移植到任何支持 protobuf 的编程语言中
- 代码作为子模块签出于`common/protobuf-c`

##### 5.2.1 依赖关系如何协同工作（简短解释）



- RPC请求-响应
  - Wi-Fi Remote 是一个 API 层或接口，它为应用程序提供标准 ESP-IDF Wi-Fi 调用（`esp_wifi_init()`等）
  - Wi-Fi Remote 将 Wi-Fi 调用转发到 ESP-Hosted，因为 ESP-Hosted“实现”了 Wi-Fi Remote 接口提供的 API。
  - ESP-Hosted 主机 MCU 创建 protobuf 编码的 RPC 请求并通过传输（SPI/SDIO 等）发送给从属设备。
  - 从属设备对 protobuf RPC 请求进行反序列化，并通过传输将响应发送回主机，同样使用 protobuf 序列化。
  - 传输过程中收到的响应返回到 Wi-Fi Remote，后者将响应返回到主机上的调用应用程序
  - 对于应用程序来说，这就像进行了标准 ESP-IDF Wi-Fi API 调用一样。
- RPC事件
  - 订阅时异步 Wi-Fi 事件由从属设备发送给主机。
  - 这些事件在主机上的标准 ESP-IDF 事件循环中终止
- 请注意，只有 RPC 数据包（即控制数据包）会被序列化。数据包永远不会被序列化，因为它们不需要字节序转换。

## 6 确定主机和从机之间的通信总线



主机和从机之间需要正确设置通信总线。我们称之为`transport medium`或简称`transport`。

ESP-Hosted-MCU 支持 SPI/SDIO/UART 传输协议。用户可以自行选择使用哪种传输协议。具体选择哪种传输协议取决于以下因素：高性能、易于快速测试、使用的 GPIO 数量，或者仅仅是协处理器的偏好。

下面是运输介质比较图表。

图例：

- `FD`：全双工通信

- `HD`：半双工通信

- `BT`： 蓝牙

- ```
  +2
  ```

  在列中

  ```
  Num of GPIOs
  ```

  - 有两个额外的 GPIO 适用于所有传输
  - （1）协处理器复位：主机需要一个额外的引脚连接到协处理器的`RST`/引脚，以便在启动时复位`EN`
  - （2）地：两个芯片组的地需要连接。
  - 如果使用跳线连接，请在两块板之间连接尽可能多的接地，以实现更好的噪声消除。

- ```
  Any_Slave
  ```

  - 支持的协处理器：ESP32、ESP32-C2、ESP32-C3、ESP32-C5、ESP32-C6、ESP32-S2、ESP32-S3
  - 经典 ESP32 支持“经典 BT”、“BLE 4.2”和“BTDM”
  - 其余所有芯片组仅支持 BLE。支持的 BLE 版本为 5.0 及以上。具体蓝牙版本信息请参考[ESP 产品选择器页面。](https://products.espressif.com/#/product-selector)

- ```
  Dedicated platforms
  ```

  - 蓝牙使用专用平台，UART 和 Wi-Fi 使用任何其他基础传输
  - 在其他平台中，蓝牙和 Wi-Fi 重复使用相同的平台，因此使用更少的 GPIO，并且不太复杂
  - 这种传输组合允许蓝牙使用专用 uart 传输，并根据硬件流控制额外增加 2 个或 4 个。

- (S) ：屏蔽盒读数

- (O) ：无线读取

- TBD：待定

- iperf：iperf2 的测试结果（以 mbps 为单位）

笔记

对于使用 (S) 进行的屏蔽盒读数，完整的网络设置在[屏蔽盒测试设置中进行了说明](https://github.com/espressif/esp-hosted-mcu/blob/main/shield-box-test-setup.md)

**主机可以是任何 ESP 芯片组或任何非 ESP MCU。**

###### 托管传输表



| 运输              | 类型 | GPIO数量    | 设置       | 支持协处理器                  | 主机 Tx iperf             | 主机 Rx iperf            | 评论                                      |
| ----------------- | ---- | ----------- | ---------- | ----------------------------- | ------------------------- | ------------------------ | ----------------------------------------- |
| 标准SPI           | FD   | 6           | 跳线或 PCB | 任意从属                      | udp：24 tcp：22           | udp：25 tcp：22          | 最简单的快速测试解决方案                  |
| 双SPI             | 高清 | 5           | 跳线或 PCB | 任意从属 [1]                  | udp：32 tcp：26（O）      | udp：33 tcp：25（O）     | 吞吐量更高，但采用半双工                  |
| 四路 SPI          | 高清 | 7           | 仅 PCB     | 任意从属 [1]                  | udp：41 tcp：29（O）      | udp：42 tcp：28（O）     | 由于信号完整性，PCB 是必需的              |
| SDIO 1位          | 高清 | 4           | 跳线或 PCB | ESP32、ESP32-C6、ESP32-C5 [3] | 待定                      | 待定                     | 基于 PCB 的 SDIO 4 位垫脚石               |
| SDIO 4位          | 高清 | 6           | 仅 PCB     | ESP32、ESP32-C6、ESP32-C5 [3] | udp：79.5 tcp：53.4（秒） | udp：68.1 tcp：44（S）   | 最高性能                                  |
| 仅限 UART 上的 BT | FD   | 2 或 4      | 跳线或 PCB | 任意从属                      | 不适用                    | 不适用                   | 专用蓝牙 UART 引脚                        |
| 通用异步收发器    | FD   | 2           | 跳线或 PCB | 任意从属                      | udp：0.68 tcp：0.67（O）  | udp：0.68 tcp：0.60（O） | 蓝牙和Wi-Fi专用UART [2]                   |
| 专用平台          | FD   | 额外 2 或 4 | 跳线或 PCB | 任意从属                      | 不适用                    | 不适用                   | UART 专用于任何其他传输方式的 BT 和 Wi-Fi |

笔记

- [1] ESP32 不支持双/四 SPI
- [2] UART 仅适用于低吞吐量环境
- [3] 目前处于 BETA 阶段，支持 ESP32-C5（`--preview`位于 ESP-IDF master 分支）

使用跳线，“标准 SPI”和“双 SPI”解决方案最容易评估，且对硬件没有太多依赖。SDIO 1-Bit 可以使用跳线进行测试，但需要一些额外的硬件配置，例如安装外部上拉寄存器。

对于专用平台，蓝牙使用基于 UART 的标准 HCI。在其他情况下，蓝牙和 Wi-Fi 使用相同的传输方式，因此 GPIO 更少，复杂性也更低。在共享模式下，蓝牙以 Hosted HCI（多路复用模式）运行。

## 7 ESP-Hosted-MCU 头文件



### 7.1 ESP 托管标头



主机和从机总是在每一帧开始时填充下面的标题，而不管有效载荷中的实际数据或虚拟数据。

| 场地                          | 类型     | 位     | 强制的？ | 描述                                       |
| ----------------------------- | -------- | ------ | -------- | ------------------------------------------ |
| 如果类型                      | uint8_t  | 4      | 米       | 接口类型                                   |
| 如果_num                      | uint8_t  | 4      | 米       | 接口编号                                   |
| 旗帜                          | uint8_t  | 8      | 米       | 附加信息标志                               |
| len                           | uint16_t | 16     | 米       | 有效载荷的长度                             |
| 抵消                          | uint16_t | 16     | 米       | 有效载荷的偏移量                           |
| 校验和                        | uint16_t | 16     | 米       | 错误检测的校验和（如果禁用校验和，则为 0） |
| 序列号                        | uint16_t | 16     | 哦       | 跟踪数据包的序列号（在调试时有用）         |
| throttle_cmd                  | uint8_t  | 0 或 2 | 哦       | 流控命令                                   |
| 保留2                         | uint8_t  | 6或8   | 米       | 保留位                                     |
| 保留3                         | uint8_t  | 8      | 米       | 保留字节（联合字段）                       |
| hci_pkt_type 或 priv_pkt_type | uint8_t  | 8      | 米       | HCI 接口的数据包类型（联合字段）           |

### 7.2 接口类型



报头的开始表明正在承载哪种类型的帧。

| 接口类型       | 价值 | 描述                     |
| -------------- | ---- | ------------------------ |
| ESP_INVALID_IF | 0    | 无效接口                 |
| ESP_STA_IF     | 1    | 站架                     |
| ESP_AP_IF      | 2    | SoftAP帧                 |
| ESP_SERIAL_IF  | 3    | 控制帧                   |
| ESP_HCI_IF     | 4    | 蓝牙托管HCI框架          |
| ESP_PRIV_IF    | 5    | 从站与主机之间的私人通信 |
| ESP_TEST_IF    | 6    | 传输吞吐量测试           |
| ESP_ETH_IF     | 7    | 无效的                   |
| ESP_MAX_IF     | 8    | 虚拟或空框架中提到的类型 |

## 8 详细设置



一旦您决定使用哪种传输方式，本节将指导您如何设置该传输方式，包括硬件连接、配置和验证。用户可以先评估一种传输方式，然后再尝试其他传输方式。

重要的

[在选择任何传输方案之前，可以参考以下设计注意事项](https://github.com/espressif/esp-hosted-mcu/blob/main/docs/design_consideration.md)。参考这些注意事项有助于您更快地找到解决方案，并使您的设计更加稳定，并减少错误。

无论选择哪种运输方式，都需要执行以下步骤，每种运输方式都会逐步解释。

1. 设置托管传输
2. 从属闪烁

- 从属项目创建
- 从属配置
- 从属闪烁
- 从属日志

1. 主机闪烁

- 主机项目与 ESP-IDF 集成示例
- 主机配置
- 主机闪烁
- 主机日志
- [**标准SPI（全双工）**](https://github.com/espressif/esp-hosted-mcu/blob/main/docs/spi_full_duplex.md)
- [**SPI - 双/四半双工**](https://github.com/espressif/esp-hosted-mcu/blob/main/docs/spi_half_duplex.md)
- [**SDIO（1 位 / 4 位）**](https://github.com/espressif/esp-hosted-mcu/blob/main/docs/sdio.md)
- [**用于 Wi-Fi 和蓝牙的 UART**](https://github.com/espressif/esp-hosted-mcu/blob/main/docs/uart.md)

## 9 个例子



检查[示例](https://github.com/espressif/esp-hosted-mcu/tree/main/examples)目录中使用 ESP-Hosted 的示例应用程序。

- ```
  examples/host_bluedroid_ble_compatibility_test
  ```

  - 托管BlueDroid蓝牙示例来测试蓝牙与手机的兼容性

- ```
  examples/host_bluedroid_bt_hid_mouse_device
  ```

  - 托管 BlueDroid 蓝牙示例，展示如何使用经典蓝牙 HID 配置文件提供的 API 实现蓝牙 HID 设备

- ```
  examples/host_bluedroid_host_only
  ```

  - 主机 BlueDroid 蓝牙示例蓝牙主机使用 ESP-Hosted 作为 BT 控制器的 HCI IO

- ```
  examples/host_nimble_bleprph_host_only_vhci
  ```

  - 托管 NimBLE 蓝牙示例，无需额外的 GPIO 进行 HCI 传输

## 10 故障排除



如果您在使用 ESP-Hosted 时遇到问题，请参阅以下指南：

- [故障排除指南](https://github.com/espressif/esp-hosted-mcu/blob/main/docs/troubleshooting.md)

## 11 参考文献

- [ESP 产品选择器页面](https://products.espressif.com/)
- [ESP-IDF 入门指南](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started)
- [ESP-IDF Wi-Fi API](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/network/esp_wifi.html)
- [ESP-IDF Iperf 示例](https://github.com/espressif/esp-idf/tree/master/examples/wifi/iperf)
- [ESP-IDF NimBLE](https://github.com/espressif/esp-nimble)
- [ESP 组件注册表](https://components.espressif.com/)
- [注册表组件：esp_wifi_remote](https://components.espressif.com/components/espressif/esp_wifi_remote)
- [注册表组件：esp_hosted](https://components.espressif.com/components/espressif/esp_hosted)

