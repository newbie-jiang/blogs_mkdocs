

## 步骤



- 在内核的驱动 字符设备 创建一个helloworld文件夹
- 编写Kconfig文件 添加helloworld 驱动
- 在上层目录的kconfig中包含helloworld目录下的Kconfig（到这一步可以使用make menuconfig查看是否成功）



## 1.在字符驱动目录下创建一个helloworld目录

```
/home/ubuntu/rk3568/linux_sdk/kernel/drivers/char/helloworld
```

## 2.打开helloworld目录并编写Kconfig文件

Kconfig

```
menu "HelloWorld driver"

config HELLOWORLD
	tristate "Hello World driver"
	help
	  A simple hello world driver.
	  Say Y to build it into the kernel,
	  M to build as a module,
	  N to exclude it.

endmenu

```

## 3.在上一层Kconfig包含helloworld中的Kconfig

```
source "drivers/char/helloworld/Kconfig"
```

### 先验证Kconfig是否添加成功

```
export ARCH=arm64
make menuconfig
```

```
  Device Drivers  --->
       Character devices  ---> 
               HelloWorld driver  ---> 
                    
   
```

![image-20250819211307066](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/TyporaJPG/image-20250819211307066.png)



## 4.添加hellworld.c 驱动

```c
#include <linux/init.h>
#include <linux/module.h>

static int __init hello_init(void)
{
    pr_info("Hello, world driver loaded!\n");
    return 0;
}

static void __exit hello_exit(void)
{
    pr_info("Hello, world driver unloaded!\n");
}

module_init(hello_init);
module_exit(hello_exit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("You");
MODULE_DESCRIPTION("Simple Hello World driver");

```



## 5.编写Makefile

- 此处的CONFIG_HELLOWORLD  需要与Kconfig文件对应 config HELLOWORLD

```
obj-$(CONFIG_HELLOWORLD) += helloworld.o
```

## 6.在上一层Makefile包含helloworld中的Makefile

```
obj-$(CONFIG_HELLOWORLD) += helloworld/
```



## 7.更改编译config文件

```
ubuntu@ubuntu1804:~/rk3568/linux_sdk$ ./build.sh kernel
processing option: kernel
============Start building kernel============
TARGET_ARCH          =arm64
TARGET_KERNEL_CONFIG =rockchip_linux_defconfig
TARGET_KERNEL_DTS    =rk3568-evb1-ddr4-v10-linux
TARGET_KERNEL_CONFIG_FRAGMENT =
==========================================

```

默认编译时可以看到使用的是rockchip_linux_defconfig 文件，与make menuconfig出来的.config无关，这时候可以将rockchip_linux_defconfig覆盖

在kernel目录下执行如下命令

```
cp .config arch/arm64/configs/rockchip_linux_defconfig
```

覆盖是否成功，检查最后更新时间

![image-20250819213442658](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/TyporaJPG/image-20250819213442658.png)

## 编译

```
 ./build.sh kernel
```



## 烧录镜像

![image-20250819215132908](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/TyporaJPG/image-20250819215132908.png)

## 检查

- 查看驱动是否有被编译的文件

![image-20250819214821504](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/TyporaJPG/image-20250819214821504.png)

- 查看 **内核启动日志**

```
[root@topeet:/dev]# dmesg | grep -i hello
[    1.762110] Hello, world driver loaded!
```

驱动已经随内核启动运行了

