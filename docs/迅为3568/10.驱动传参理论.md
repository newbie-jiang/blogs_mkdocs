Linux é©±åŠ¨è¦å’Œåº”ç”¨/å†…æ ¸å…¶ä»–éƒ¨åˆ†äº¤äº’ï¼Œå¸¸å¸¸éœ€è¦ **ä¼ é€’å‚æ•°**ã€‚

å‚æ•°ä¼ é€’æœ‰å‡ ç§å…¸å‹å½¢å¼ï¼ŒæŒ‰ **å†…æ ¸å¯åŠ¨ â†’ é©±åŠ¨åŠ è½½ â†’ è¿è¡Œæ—¶äº¤äº’** æ¥åˆ†ç±»ç»™æ¢³ç†ï¼š

# ğŸš¦1. å†…æ ¸å¯åŠ¨å‚æ•°ä¼ é€’ (bootargs â†’ é©±åŠ¨)

é©±åŠ¨å¯ä»¥é€šè¿‡ **å†…æ ¸å‘½ä»¤è¡Œå‚æ•°** æ¥æ”¶é…ç½®ã€‚

- **æœºåˆ¶**ï¼šåœ¨é©±åŠ¨é‡Œç”¨ `module_param()` æˆ– `__setup()`ã€‚

### ç¤ºä¾‹ï¼š`module_param`

```
static int debug = 0;
module_param(debug, int, 0644);
MODULE_PARM_DESC(debug, "Enable debug prints");

static int __init hello_init(void)
{
    if (debug)
        pr_info("Debug mode on\n");
    return 0;
}
```

ä½¿ç”¨ï¼š

```
bootargs: hello.debug=1
```

------

# ğŸš¦ 2. æ¨¡å—åŠ è½½å‚æ•°ä¼ é€’ (`insmod xxx.ko param=...`)

å½“é©±åŠ¨æ˜¯ **æ¨¡å— (`=m`)** æ—¶ï¼Œå¯ä»¥ç›´æ¥ç»™ `.ko` ä¼ å‚ã€‚

- **å®šä¹‰**ï¼šåŒæ ·ç”¨ `module_param()` / `module_param_array()`ã€‚

- **æ–¹å¼**ï¼š

  ```
  insmod hello.ko debug=1 name="test"
  ```

- **æ•ˆæœ**ï¼šå†…æ ¸è°ƒç”¨ `hello_init()` æ—¶ï¼Œå‚æ•°å·²ç”Ÿæ•ˆã€‚

------

# ğŸš¦ 3. è®¾å¤‡æ ‘ (Device Tree, DT) å‚æ•°

åµŒå…¥å¼/SoC ä¸Šæœ€å¸¸è§ã€‚é©±åŠ¨é€šè¿‡ **è®¾å¤‡æ ‘èŠ‚ç‚¹** è·å–å‚æ•°ã€‚

### ç¤ºä¾‹

```
hello@0 {
    compatible = "myvendor,hello";
    reg = <0x1000 0x100>;
    debug-level = <2>;
    name = "dev-hello";
};
```

### é©±åŠ¨é‡Œè§£æ

```
static int hello_probe(struct platform_device *pdev)
{
    struct device_node *np = pdev->dev.of_node;
    u32 dbg;
    const char *name;

    of_property_read_u32(np, "debug-level", &dbg);
    of_property_read_string(np, "name", &name);

    pr_info("debug=%u name=%s\n", dbg, name);
    return 0;
}
```

------

# ğŸš¦ 4. å†…æ ¸ API / Sysfs / Procfs

é©±åŠ¨è¿è¡Œåï¼Œå¯ä»¥é€šè¿‡ **æ–‡ä»¶ç³»ç»Ÿæ¥å£** è®©ç”¨æˆ·æ€ä¼ å‚ã€‚

### sysfs å±æ€§

```
static ssize_t hello_show(struct device *dev,
                          struct device_attribute *attr, char *buf)
{
    return sprintf(buf, "%d\n", debug);
}

static ssize_t hello_store(struct device *dev,
                           struct device_attribute *attr,
                           const char *buf, size_t count)
{
    sscanf(buf, "%d", &debug);
    return count;
}
static DEVICE_ATTR_RW(hello);
```

ç”¨æˆ·æ€ï¼š

```
echo 1 > /sys/devices/platform/hello/hello
cat /sys/devices/platform/hello/hello
```

### procfs / debugfs

ä¸€äº›é©±åŠ¨ä¼šæš´éœ² `/proc/driver/hello` æˆ– `/sys/kernel/debug/hello` æ¥äº¤äº’ã€‚

------

# ğŸš¦ 5. IOCTL / ç”¨æˆ·ç©ºé—´è°ƒç”¨

é©±åŠ¨æä¾› **å­—ç¬¦è®¾å¤‡èŠ‚ç‚¹**ï¼Œé€šè¿‡ `ioctl()` ä¸åº”ç”¨ç¨‹åºäº¤äº’ï¼Œä¼ é€’å¤æ‚å‚æ•°ã€‚

é©±åŠ¨ï¼š

```
#define HELLO_SET_PARAM  _IOW('h', 1, int)
static long hello_ioctl(struct file *f, unsigned int cmd, unsigned long arg)
{
    int val;
    switch(cmd) {
    case HELLO_SET_PARAM:
        if (copy_from_user(&val, (int __user *)arg, sizeof(val)))
            return -EFAULT;
        debug = val;
        return 0;
    }
    return -ENOTTY;
}
```

åº”ç”¨ï¼š

```
int val = 5;
ioctl(fd, HELLO_SET_PARAM, &val);
```

# ğŸ“Œ æ€»ç»“ï¼šLinux é©±åŠ¨ä¼ å‚å¸¸è§æ–¹å¼

| æ–¹å¼                     | é€‚ç”¨åœºæ™¯          | ç‰¹ç‚¹                         |
| ------------------------ | ----------------- | ---------------------------- |
| **module_param**         | å†…æ ¸å¯åŠ¨ / insmod | é€‚åˆç®€å•å¸ƒå°”/æ•°å€¼/å­—ç¬¦ä¸²å‚æ•° |
| **è®¾å¤‡æ ‘ (DT)**          | åµŒå…¥å¼/SoC        | ä¸»æµï¼Œç¡¬ä»¶ç›¸å…³å‚æ•°æè¿°       |
| **sysfs/procfs/debugfs** | è¿è¡Œæ—¶ä¿®æ”¹        | å‚æ•°å¯åŠ¨æ€è°ƒæ•´               |
| **ioctl**                | ç”¨æˆ·ç¨‹åºäº¤äº’      | å¤æ‚æŒ‡ä»¤/ç»“æ„ä½“ä¼ é€’          |
| **å¹³å°æ•°æ®**             | è€å¼æ¿çº§æ–‡ä»¶      | ç°åœ¨å·²å°‘ç”¨                   |

âœ… ä¸€å¥è¯æ€»ç»“ï¼š

- **ç¼–è¯‘/å¯åŠ¨æ—¶**ï¼š`bootargs`ã€`module_param`
- **ç¡¬ä»¶æè¿°**ï¼šè®¾å¤‡æ ‘ (DT)
- **è¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹**ï¼šsysfs/procfs/debugfs/ioctl