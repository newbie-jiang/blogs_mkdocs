# 如何传输内核模块？

前一节编写了第一个hello驱动，这一节看如何将驱动模块放到内核中运行



## 模块编译出来在我的电脑上，要放到开发板上，有哪些方式？

# 有网最省事

## 1) scp / sftp（首选）

前提：板子上有 SSH（openssh/dropbear）。

```
# 开发机 → 板子
scp helloworld.ko root@BOARD_IP:/tmp/
# 或交互式
sftp root@BOARD_IP
sftp> put helloworld.ko /tmp/
```

## 2) rsync（大文件/多文件更快）

```
rsync -avz helloworld.ko root@BOARD_IP:/tmp/
```

## 3) 临时 HTTP 服务 + wget/curl（板子无 SSH 也可）

开发机在 .ko 所在目录开一个临时 http：

```
python3 -m http.server 8000
```

板子上下载：

```
wget http://DEV_IP:8000/helloworld.ko -O /tmp/helloworld.ko
# 或
curl -O http://DEV_IP:8000/helloworld.ko
```

## 4) TFTP（嵌入式常用、依赖少）

开发机安装/启动 tftpd（如 tftpd-hpa），把 .ko 放到 TFTP 根目录。
 板子上：

```
tftp -g -r helloworld.ko DEV_IP -l /tmp/helloworld.ko
# 或 busybox:
tftp -g DEV_IP -r helloworld.ko -l /tmp/helloworld.ko
```

## 5) NFS 共享（开发时超高效）

开发机导出目录，板子上直接挂载：

```
# 板子
mount -t nfs DEV_IP:/path/to/share /mnt
# 之后像本地文件一样用：
cp /mnt/helloworld.ko /tmp/
```

## 6) Samba/CIFS（Windows/混合环境）

```
mount -t cifs //DEV_IP/share /mnt -o username=xxx,password=yyy
cp /mnt/helloworld.ko /tmp/
```

# 只有串口、没网络

## 7) ZMODEM（picocom/minicom + lrzsz）

在**板子**安装接收端（若没有）：

```
# Debian/Ubuntu 类
apt-get install lrzsz
```

用 `picocom` 连上后，在板子上执行：

```
cd /tmp && rz -E
```

在**开发机的 picocom**里按 `Ctrl+A` 然后 `Ctrl+S` 触发发送（选择 zmodem），选中 `helloworld.ko` 发送即可。
 （你的 picocom 默认 `send_cmd` 就是 `sz -vv`，很合适）

> 没有 lrzsz 时也可用 X/YMODEM（rx/sx/ry/sy），但 zmodem 最稳。

## 8) XMODEM/YMODEM（你之前提过 ymodem）

- 板子上：`rb`/`rx`/`rz`/`sb`/`sx`/`sz`（视可用工具而定）
- 流程与上面类似，速度略慢、可靠性较 zmodem 差一点

# 可移动介质

## 9) U 盘 / TF 卡

开发机拷贝 → 插到板子上挂载：

```
mount /dev/sda1 /mnt   # 设备名看 dmesg
cp /mnt/helloworld.ko /tmp/
umount /mnt
```

## 10) USB-OTG/MSC Gadget（板子把自身伪装成 U 盘）

适合没有存储器口但有 OTG 的设备，需要 gadget 模块支持；略复杂，开发期偶尔用。

# Android 固件（若 RK3568 跑的是 Android）

## 11) ADB

```
adb push helloworld.ko /data/local/tmp/
adb shell
#> su
#> insmod /data/local/tmp/helloworld.ko
```

------

# 传过去后的验证（通用）

```
# 板子上
modinfo /tmp/helloworld.ko        # 看 vermagic、依赖等
uname -r                           # 确认与内核版本匹配
sudo insmod /tmp/helloworld.ko
dmesg | tail -n 50
lsmod | grep helloworld
sudo rmmod helloworld
```

# 选型建议（怎么选最快）

- 有 SSH ⇒ 用 **scp/rsync**。
- 有网没 SSH ⇒ **HTTP + wget** 或 **TFTP**。
- 完全离线只有串口 /USB ⇒ **ZMODEM（rz/sz）**。
- 频繁迭代、多文件 ⇒ **NFS 挂载**最爽。



我的板子网络已经通了，但是我不知道有什么传输服务开启了

```
which scp
which sftp
which wget
which curl
which tftp
which rz
```



```
[root@topeet:/]# which scp
h sftp
which wget
which curl
which tftp
which rz
/usr/bin/scp
[root@topeet:/]# which sftp
[root@topeet:/]# which wget
/usr/bin/wget
[root@topeet:/]# which curl
[root@topeet:/]# which tftp
/usr/bin/tftp
[root@topeet:/]# which rz
/usr/bin/rz

```

已经开启的服务

```
✅ scp → 最常用、最方便

✅ wget → 如果 PC 上开 HTTP 服务，也能下载

✅ tftp → 适合嵌入式环境

✅ rz → 可以通过串口传文件
```

## 使用scp服务

学两条scp的指令

```
在 开发机（Ubuntu） 上执行：
scp helloworld.ko root@BOARD_IP:/tmp/

然后在板子上：
insmod /tmp/helloworld.ko
```



主机

```
ubuntu@ubuntu1804:~/rk3568/driver/01_helloworld$ scp helloworld.ko root@192.168.0.104:/tmp/
The authenticity of host '192.168.0.104 (192.168.0.104)' can't be established.
ECDSA key fingerprint is SHA256:UQiERmq9suYMmC7+EDO+fL4C58oSkvP4pCHYzvzU6oU.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.0.104' (ECDSA) to the list of known hosts.
root@192.168.0.104's password: 
helloworld.ko              100%  159KB  12.0MB/s   00:00                                                                                                                                                                                                                                                                     
```

开发板

```
[root@topeet:/tmp]# ls
dbus  dnsmasq.leases  messages  messages.0  mountall.log  resolv.conf  subsys
[root@topeet:/tmp]# ls
dbus  dnsmasq.leases  helloworld.ko  messages  messages.0  mountall.log  resolv.conf  subsys
[root@topeet:/tmp]# 
```









