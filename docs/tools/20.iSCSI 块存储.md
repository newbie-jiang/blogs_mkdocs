## 块存储

**在 A 主机上直接运行程序并把 B 服务器当成本地盘一样使用**，同时还要用于下载文件，建议走 **块级存储方案（iSCSI 或 NBD）**，因为它比文件共享更贴近本地盘的体验。

## **推荐方案：iSCSI（首选）**

### **优点**

- 表现接近本地磁盘
- 兼容性好，Linux 原生支持
- 可以格式化为 ext4/xfs 等文件系统
- 稳定性和恢复机制较好

### **1. B 服务器（作为存储服务器）配置**

安装 iSCSI Target 服务：

```
sudo apt update && sudo apt install tgt -y
```

创建存储目录：

- **创建一个大小为 100 GB 的空白镜像文件**，这个文件会作为 iSCSI 的“虚拟磁盘”

```
sudo mkdir -p /data/iscsi
sudo dd if=/dev/zero of=/data/iscsi/disk1.img bs=1G count=100
```



配置 iSCSI：

```
sudo nano /etc/tgt/conf.d/iscsi.conf
```

添加：

- your_password 需要设置自己的登录密码

```
<target iqn.2025-08.local:storage.disk1>
    backing-store /data/iscsi/disk1.img
    initiator-address ALL
    incominguser iscsiuser your_password
</target>
```

启动服务：

```
sudo systemctl enable tgt --now
```

```
sudo systemctl restart tgt
sudo tgtadm --mode target --op show
```

查看状态

```
systemctl status tgt
```

![image-20250822154440215](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/TyporaJPG/image-20250822154440215.png)

## 开放3260端口







### **2. A 主机（作为客户端）配置**

安装 iSCSI 客户端：

```
sudo apt install open-iscsi -y
```

发现 B 主机的 iSCSI 目标：

```
sudo iscsiadm -m discovery -t sendtargets -p 142.171.255.55
```

![image-20250822160729746](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/TyporaJPG/image-20250822160729746.png)

登录：

- your_password 需要改写自己设置的登录密码

```
# 写入 CHAP 认证参数
sudo iscsiadm -m node -T iqn.2025-08.local:storage.disk1 -p 142.171.255.55 \
  --op update -n node.session.auth.authmethod -v CHAP
sudo iscsiadm -m node -T iqn.2025-08.local:storage.disk1 -p 142.171.255.55 \
  --op update -n node.session.auth.username -v iscsiuser
sudo iscsiadm -m node -T iqn.2025-08.local:storage.disk1 -p 142.171.255.55 \
  --op update -n node.session.auth.password -v 'your_password'

# 登录
sudo iscsiadm -m node -T iqn.2025-08.local:storage.disk1 -p 142.171.255.55 --login
```

```
root@s16396 ~ # sudo iscsiadm -m node -T iqn.2025-08.local:storage.disk1 -p 142.171.255.55 --login
Logging in to [iface: default, target: iqn.2025-08.local:storage.disk1, portal: 142.171.255.55,3260]
Login to [iface: default, target: iqn.2025-08.local:storage.disk1, portal: 142.171.255.55,3260] successful.

```



查看挂载的块设备：

```
lsblk
```

```
root@s16396 ~ # lsblk
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
sda      8:0    0  100G  0 disk 
sr0     11:0    1    4M  0 rom  
sr1     11:1    1 1024M  0 rom  
vda    252:0    0   15G  0 disk 
└─vda1 252:1    0   15G  0 part /

```

- sda 100G

确认磁盘信息

```
root@s16396 ~ # sudo fdisk -l
Disk /dev/vda: 15 GiB, 16106127360 bytes, 31457280 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xbeefbeef

Device     Boot Start      End  Sectors Size Id Type
/dev/vda1  *     2048 31457246 31455199  15G 83 Linux


Disk /dev/sda: 100 GiB, 107374182400 bytes, 209715200 sectors
Disk model: VIRTUAL-DISK    
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes

```

格式化：

```
sudo mkfs.ext4 /dev/sda
```

挂载：

```
sudo mkdir -p /mnt/iscsi
sudo mount /dev/sda /mnt/iscsi
```

------

测试

```
df -h | grep iscsi
```



### **4. 开机自动挂载**

编辑 `/etc/fstab`：

```
sudo nano /etc/fstab
```

添加：

```
/dev/sda   /mnt/iscsi   ext4   _netdev   0  0
```

保存后测试：

```
sudo mount -a
```

------

### **5. 自动登录 iSCSI**

确保 iSCSI 在开机自动登录：

```
sudo iscsiadm -m node -T iqn.2025-08.local:storage.disk1 -p 142.171.255.55 --op update -n node.startup -v automatic
```

然后检查是否设置成功：

```
sudo iscsiadm -m node
```

完成后，这块 100G 的远程磁盘就会像本地磁盘一样使用，可以用来：

- 存放下载文件
- 做 Docker 数据卷
- 存放数据库或程序数据



## 最终测试：

## **1. 顺序写入/读取测试（`dd`）**

### **顺序写测试**

```
sudo dd if=/dev/zero of=/mnt/iscsi/testfile bs=100M count=1 oflag=direct
```

- **`oflag=direct`** 跳过系统缓存，直接写到磁盘

- 结果会显示写入速度，例如：

  

### **顺序读测试**

```
sudo dd if=/mnt/iscsi/testfile of=/dev/null bs=100M count=1 iflag=direct
```

- 直接从磁盘读取，不走缓存。

![image-20250822163339669](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/TyporaJPG/image-20250822163339669.png)

------

## **2. 使用 `fio` 做更真实的压力测试**

如果没有 `fio`，先安装：

```
sudo apt install fio -y
```

### **随机读写混合测试**

```
fio --name=iscsi-test --filename=/mnt/iscsi/fio_testfile --size=100M --bs=4k --rw=randrw --rwmixread=70 --iodepth=32 --numjobs=4 --direct=1 --runtime=60 --group_reporting
```

参数解释：

| 参数             | 含义               |
| ---------------- | ------------------ |
| `--size=100M`    | 测试文件大小       |
| `--bs=4k`        | 块大小 4KB         |
| `--rw=randrw`    | 随机读写           |
| `--rwmixread=70` | 70% 读，30% 写     |
| `--iodepth=32`   | 并发深度           |
| `--numjobs=4`    | 4 个并发任务       |
| `--direct=1`     | 直接 I/O，不走缓存 |
| `--runtime=60`   | 持续 60 秒测试     |

输出示例：

![image-20250822163716554](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/TyporaJPG/image-20250822163716554.png)

```
测试 read  write 读写性能较差
```

------

## **3. 使用 `hdparm` 测试顺序读取速度**

如果想单测块设备 `/dev/sda` 的读取：

```
sudo hdparm -tT /dev/sda
```

输出

![image-20250822164006836](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/TyporaJPG/image-20250822164006836.png)



------

## **4. 清理测试文件**

测试完成后删除生成的文件：

```
sudo rm -f /mnt/iscsi/testfile /mnt/iscsi/fio_testfile
```

